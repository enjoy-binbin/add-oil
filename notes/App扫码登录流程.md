#### 扫二维码登录

近些年来，越来越多的网站支持使用手机 APP 扫二维码进行登录。例如微信登录、QQ登录、百度云登录等

以前的的登录方式是需要用户在浏览器中输入账号和密码，完成输入之后点击登录按钮将这些数据POST发送到服务器上，服务器对这些数据进行验证，验证通过后返回特定的状态码和 Cookie 等信息给浏览器。

但是扫二维码登录这种方式就不需要用户输入账号密码了，这些数据都保存在手机 APP 中，并由 APP 发送到服务器上。但是这种方式有几个问题需要解决：

1. 服务器不能主动发送信息给自己浏览器，那么要怎么才能将服务器验证结果返回给浏览器呢？
2. 要怎么保证浏览器的登录信息和某个账户关联？



#### 微信网页版登录

打开微信网页版 https://wx.qq.com/ 后会出现登录二维码：

使用二维码识别软件可以得到这个二维码中包含的字符串信息，例如浏览器扫码，这是一个 URL  地址，

`https://login.weixin.qq.com/l/Ae7uHQE29w==`

包含了一个参数 `l=Ae7uHQE29w==`。

再打开 浏览器  的开发者工具观察网络请求，注意到浏览器在不断的在给一个链接发GET请求。

`https://login.wx.qq.com/cgi-bin/mmwebwx-bin/login?loginicon=true&uuid=Ae7uHQE29w==&tip=0&r=1066168380&_=1562301901805`

这个请求，并且其中的 uuid 参数值和二维码中的 I 参数是一样。

当我们扫码成功登录后，会得到这样的一个请求链接，其中的ticket应该就是凭证

`https://wx2.qq.com/cgi-bin/mmwebwx-bin/webwxnewloginpage?ticket=AwgXAAe2UfHpErGhhBd8Pciy@qrticket_0&uuid=Ae7uHQE29w==&lang=zh_CN&scan=1562302078`



#### 结论

通过上面的分析我们知道，登录二维码包含了服务器的 URL 地址，其中也包含了 我们uuid 参数。当用户使用手机 APP 扫描二维码登录之后，携带者二维码中的uuid和用户信息发送给服务器，服务器验证之后就将 uuid 和该账户关联并保存到 Session 中。

浏览器需要不断地向服务器发送 AJAX 请求，该请求包含了 uuid 参数，当查询到服务器已经存在 uuid 和账户的关联信息之后，就可以知道是某个账户扫描了该二维码登录，服务器返回 200 成功状态码、Cookie 和账户信息等数据，浏览器接受到这些数据之后就可以完成登录操作。应该注意到，为了使的浏览器能不断发送 AJAX 请求，建立的 HTTP 连接需要是长连接。

所以说，核心过程应该是：浏览器获得一个临时 id，通过长连接等待客户端扫描带有此 id 的二维码后，从长连接中获得客户端上报给 server 的帐号信息进行展示。 并在客户端点击确认后，获得服务器授信的令牌，进行随后的信息交互过程。 在超时、网络断开、其他设备上登录后，此前获得的令牌或丢失、或失效，对授权过程形成有效的安全防护。



#### 参考资料

- [微信扫描二维码登录网页是什么原理，前后两个事件是如何联系的？](https://www.zhihu.com/question/20368066)
- [微信二维码登录的原理](https://www.biaodianfu.com/weixin-qrcode.html)
